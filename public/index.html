<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>MapLibre Rectangle + 3D Buildings</title>

    <!-- MapLibre -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css" />

    <!-- Bootstrap (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />


    <style>
        :root {
            /* default (light-ish) */
            --panel-bg: rgba(245, 245, 245, 0.80);
            --panel-border: rgba(0, 0, 0, 0.10);
            --text: #111;
            --muted: rgba(0, 0, 0, 0.55);

            --btn-primary-bg: #2b6cb0;
            --btn-primary-border: #2b6cb0;

            --btn-success-bg: #2f855a;
            --btn-success-border: #2f855a;

            --btn-clear-bg: rgba(0, 0, 0, 0.06);
            --btn-clear-border: rgba(0, 0, 0, 0.18);

            --switch-on: #2b6cb0;
            --switch-off-bg: rgba(0, 0, 0, 0.06);
            --switch-off-border: rgba(0, 0, 0, 0.18);
        }

        html[data-ui-theme="dark"] {
            --panel-bg: rgba(35, 35, 35, 0.78);
            --panel-border: rgba(255, 255, 255, 0.12);
            --text: #fff;
            --muted: rgba(255, 255, 255, 0.65);

            --btn-clear-bg: rgba(255, 255, 255, 0.10);
            --btn-clear-border: rgba(255, 255, 255, 0.35);

            --switch-off-bg: rgba(255, 255, 255, 0.10);
            --switch-off-border: rgba(255, 255, 255, 0.35);
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #map {
            position: absolute;
            inset: 0;
        }

        /* Floating panel */
        #toolbar {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            width: 200px;
            max-width: calc(100vw - 24px);
        }

        /* Stats panel */
        #statsPanel {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            width: 260px;
            max-width: calc(100vw - 24px);
        }

        .map-panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text);
        }

        .map-panel .form-select,
        .map-panel .form-check-label,
        .map-panel .btn,
        .map-panel .text-muted,
        .map-panel .form-label {
            color: var(--text);
        }

        .map-panel .text-muted {
            color: var(--muted) !important;
        }

        /* Buttons */
        #drawButton {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-border);
            color: var(--text);
        }

        #build3DButton {
            background-color: var(--btn-success-bg);
            border-color: var(--btn-success-border);
            color: var(--text);
        }

        #clearButton {
            background: var(--btn-clear-bg);
            border-color: var(--btn-clear-border);
            color: var(--text);
        }

        /* Switches */
        .form-check-input {
            background-color: var(--switch-off-bg);
            border-color: var(--switch-off-border);
        }

        .form-check-input:checked {
            background-color: var(--switch-on);
            border-color: var(--switch-on);
        }

        /* Make the CLOSED theme dropdown readable in dark UI */
        html[data-ui-theme="dark"] .map-panel .form-select {
            background-color: rgba(37, 37, 37, 0.7);
            border-color: rgba(255, 255, 255, 0.18);
            color: #fff;
        }

        /* Make the opened list readable (works in many browsers; some OS-level dropdowns ignore it) */
        html[data-ui-theme="dark"] .map-panel .form-select option {
            background-color: #151515;
            color: #fff;
        }

        /* Optional: improve focus ring in dark mode */
        html[data-ui-theme="dark"] .map-panel .form-select:focus {
            border-color: rgba(255, 255, 255, 0.28);
            box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.12);
        }

        .panel-block {
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            padding: 0.5rem;
        }

        .chart-box {
            position: relative;
            width: 100%;
        }

        .chart-box--bar {
            height: 160px;
        }

        .chart-box--pie {
            height: 220px;
        }

        /* default */
    </style>
</head>

<body>
    <!-- Toolbar panel -->
    <div id="toolbar" class="card shadow-sm map-panel">
        <div class="card-body p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="fw-semibold">Controls</div>
                <span class="badge text-bg-secondary">DTCC</span>
            </div>

            <!-- Theme -->
            <div class="mb-3">
                <label for="themeSelect" class="form-label mb-1">Theme</label>
                <select id="themeSelect" class="form-select form-select-sm">
                    <option value="light" selected>Light</option>
                    <option value="dark">Dark</option>
                    <option value="default">Default</option>
                    <option value="positron">Positron</option>
                    <option value="osmBright">OSM Bright</option>
                </select>
            </div>

            <!-- Buttons -->
            <div class="d-grid gap-2 mb-3">
                <button id="drawButton" class="btn btn-sm btn-dt-draw">
                    Draw rectangle
                </button>

                <!-- Build options (hidden until a selection exists) -->
                <div id="buildOptions" class="vstack gap-2 d-none">
                    <div class="small text-muted">Include in build</div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="includeBuildings" checked>
                        <label class="form-check-label" for="includeBuildings">Buildings</label>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="includeBuses">
                        <label class="form-check-label" for="includeBuses">Buses</label>
                    </div>
                </div>
                <button id="build3DButton" class="btn btn-sm btn-dt-build">
                    Build Twin
                </button>

                <!-- Toggles -->
                <div id="toggles" class="vstack gap-2 mb-3 d-none">
                    <div id="toggleSelectionRow" class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleSelection" checked>
                        <label class="form-check-label" for="toggleSelection">Show selection</label>
                    </div>

                    <div id="toggleBuildingsRow" class="form-check form-switch d-none">
                        <input class="form-check-input" type="checkbox" id="toggleBuildings" checked>
                        <label class="form-check-label" for="toggleBuildings">Show buildings</label>
                    </div>

                    <div id="toggleBusesRow" class="form-check form-switch d-none">
                        <input class="form-check-input" type="checkbox" id="toggleBuses" checked>
                        <label class="form-check-label" for="toggleBuses">Show buses</label>
                    </div>
                </div>


                <button id="clearButton" class="btn btn-sm btn-dt-clear">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Stats panel (right side) -->
    <div id="statsPanel" class="card shadow-sm map-panel">
        <div class="card-body p-3">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="fw-semibold">Model stats</div>
                <span id="statsStatus" class="badge text-bg-secondary">No model</span>
            </div>

            <!-- Key stats block -->
            <div class="panel-block mb-3">
                <div class="small text-muted mb-2">Summary</div>

                <div class="vstack gap-2 small">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Selected buildings</span>
                        <span id="statBuildings">–</span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Selection area</span>
                        <span id="statArea">–</span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Buses enabled</span>
                        <span id="statBuses">–</span>
                    </div>
                </div>
            </div>

            <!-- Chart block -->
            <div class="panel-block mb-3">
                <div class="d-flex align-items-baseline justify-content-between mb-2">
                    <div class="small text-muted">Height distribution</div>
                    <div class="small text-muted">m</div>
                </div>
                <canvas id="statsChart" height="140"></canvas>
            </div>

            <!-- Chart block -->
            <div class="panel-block">
                <div class="d-flex align-items-baseline justify-content-between mb-2">
                    <div class="small text-muted">Building types</div>
                    <div class="small text-muted">count</div>
                </div>

                <div class="chart-box chart-box--pie">
                    <canvas id="typesChart"></canvas>
                </div>
            </div>


            <div class="small text-muted mt-3" id="statNote">
                Draw a rectangle and build to see statistics here.
            </div>




        </div>
    </div>



    <div id="map"></div>

    <!-- MapLibre + Turf as globals -->
    <script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Bootstrap JS bundle (optional; only needed for dropdowns/modals/tooltips etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- Chart.js for stats panel -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


    <!-- Your entry file -->
    <script type="module" src="./src/main.js"></script>
</body>

</html>